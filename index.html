<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Partner Scout | Intelligence Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: #0a0f1e;
            min-height: 100vh;
        }
        
        .analyzer-card {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(71, 85, 105, 0.3);
        }
        
        .scan-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(71, 85, 105, 0.5);
            transition: all 0.3s ease;
        }
        
        .scan-input:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.6);
            background: rgba(0, 0, 0, 0.6);
        }
        
        .clarification-box {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            animation: slideDown 0.4s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
            border: 2px solid rgba(99, 102, 241, 0.3);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.4s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .progress-bar {
            width: 100%;
            height: 2px;
            background: rgba(71, 85, 105, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            animation: progress 2.5s ease-in-out;
        }
        
        @keyframes progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .match-score {
            font-size: 4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(71, 85, 105, 0.5), transparent);
        }
        
        .question-card {
            background: rgba(99, 102, 241, 0.05);
            border-left: 2px solid rgba(99, 102, 241, 0.5);
            transition: all 0.2s ease;
        }
        
        .question-card:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .friction-card {
            background: rgba(239, 68, 68, 0.05);
            border-left: 2px solid rgba(239, 68, 68, 0.5);
        }
        
        .hidden {
            display: none !important;
        }
        
        .insight-badge {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #86efac;
        }
    </style>
</head>
<body class="text-gray-100">
    <div class="min-h-screen p-6">
        <div class="max-w-4xl mx-auto">
            <!-- Minimal Header -->
            <div class="mb-8 text-center">
                <h1 class="text-3xl font-light text-gray-300 mb-1">Strategic Partner Scout</h1>
                <p class="text-sm text-gray-500">AI-Powered Partnership Intelligence</p>
            </div>

            <!-- Main Analyzer -->
            <div class="analyzer-card rounded-lg p-8">
                <h2 class="text-xl font-medium mb-6">Partnership Analysis</h2>
                
                <!-- Initial URL Input -->
                <div id="initialInput">
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="text-sm text-gray-400 mb-2 block">Your Company Website</label>
                            <input 
                                type="url" 
                                id="anchorUrl"
                                placeholder="https://your-company.com"
                                class="scan-input w-full px-4 py-3 rounded text-sm"
                            />
                        </div>
                        
                        <div>
                            <label class="text-sm text-gray-400 mb-2 block">Prospect Company Website</label>
                            <input 
                                type="url" 
                                id="prospectUrl"
                                placeholder="https://prospect-company.com"
                                class="scan-input w-full px-4 py-3 rounded text-sm"
                            />
                        </div>
                    </div>
                    
                    <button 
                        id="analyzeBtn"
                        type="button"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 px-6 py-3 rounded font-medium transition-all"
                    >
                        Analyze Partnership Fit
                    </button>
                </div>
                
                <!-- Progress Indicator -->
                <div id="progressSection" class="hidden">
                    <div class="text-center py-12">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-sm text-gray-400 mb-2" id="progressText">Initializing scan...</p>
                        <p class="text-xs text-gray-500" id="progressSubtext"></p>
                        <div class="progress-bar mt-4">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Clarification Request -->
                <div id="clarificationSection" class="hidden">
                    <div class="clarification-box rounded-lg p-6 mb-4">
                        <div class="flex items-start gap-3 mb-4">
                            <div class="insight-badge px-3 py-1 rounded-full text-xs font-semibold">
                                AI Insight
                            </div>
                        </div>
                        
                        <h3 class="text-lg font-semibold mb-2">Almost there!</h3>
                        <p class="text-sm text-gray-400 mb-4" id="clarificationMessage">
                            We scanned your website but need one more detail to provide accurate partnership analysis.
                        </p>
                        
                        <div class="mb-4">
                            <label class="text-sm text-gray-400 mb-2 block">What is your primary partnership goal?</label>
                            <input 
                                type="text" 
                                id="partnershipGoal"
                                placeholder="e.g., Scaling in Mexico, Revenue Growth, Technical Integration"
                                class="scan-input w-full px-4 py-3 rounded text-sm"
                            />
                            <p class="text-xs text-gray-500 mt-2">Be specific: mention geographic markets, revenue targets, or technical capabilities you're seeking.</p>
                        </div>
                        
                        <div class="flex gap-3">
                            <button 
                                id="continueBtn"
                                type="button"
                                class="flex-1 bg-indigo-600 hover:bg-indigo-700 px-6 py-3 rounded font-medium transition-all"
                            >
                                Continue Analysis
                            </button>
                            <button 
                                id="cancelBtn"
                                type="button"
                                class="px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded font-medium transition-all"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Show what we found -->
                    <div class="text-xs text-gray-500 space-y-1">
                        <p>✓ Company identified: <span id="foundCompany" class="text-gray-400"></span></p>
                        <p>✓ Industry detected: <span id="foundIndustry" class="text-gray-400"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div id="analysisModal" class="modal-overlay hidden">
        <div class="modal-content rounded-lg">
            <div class="p-8">
                <!-- Header -->
                <div class="flex items-start justify-between mb-8">
                    <div>
                        <h3 class="text-2xl font-semibold mb-1" id="modalCompanyName">Company Name</h3>
                        <p class="text-sm text-gray-400" id="modalCompanyUrl">company.com</p>
                    </div>
                    <button id="closeModalBtn" type="button" class="p-2 hover:bg-slate-700/50 rounded transition-all">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Match Score -->
                <div class="text-center mb-8">
                    <div class="match-score mb-2" id="modalMatchScore">0%</div>
                    <p class="text-xs text-gray-500 uppercase tracking-wider">Strategic Match Score</p>
                </div>
                
                <div class="section-divider mb-8"></div>
                
                <!-- Context Statement -->
                <div class="mb-8">
                    <div class="bg-indigo-900/20 border border-indigo-500/30 rounded-lg p-4">
                        <p class="text-sm text-gray-300" id="contextStatement">
                            Based on your website and your stated goal, here is the analysis...
                        </p>
                    </div>
                </div>
                
                <!-- Strategic Synergy -->
                <div class="mb-8">
                    <h4 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-3">Strategic Synergy</h4>
                    <p class="text-gray-300 leading-relaxed" id="modalSynergy">Analysis results...</p>
                </div>
                
                <!-- Potential Friction -->
                <div class="mb-8">
                    <h4 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-3">Potential Friction Points</h4>
                    <div class="friction-card p-4 rounded">
                        <p class="text-gray-300 text-sm leading-relaxed" id="modalFriction">Friction analysis...</p>
                    </div>
                </div>
                
                <div class="section-divider mb-8"></div>
                
                <!-- Vetting Questions -->
                <div>
                    <h4 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">Vetting Questions</h4>
                    <div class="space-y-3" id="modalQuestions">
                        <!-- Questions will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
(function() {
    'use strict';
    
    const supabaseUrl = 'https://xotwovmpqxqjexpuulxc.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhvdHdvdm1wcXhxamV4cHV1bHhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NDYwMjksImV4cCI6MjA4MzIyMjAyOX0.Hr-hwo1nlFx55HZuLI8cqoT6snHAR6hp_q8mOXfn1-I';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let anchorData = {};
    let prospectData = {};
    let userGoal = '';

    async function analyzePartnership() {
        const anchorUrl = document.getElementById('anchorUrl').value.trim();
        const prospectUrl = document.getElementById('prospectUrl').value.trim();
        
        if (!anchorUrl || !prospectUrl) {
            alert('Please enter both company websites');
            return;
        }
        
        try {
            new URL(anchorUrl);
            new URL(prospectUrl);
        } catch (e) {
            alert('Please enter valid URLs');
            return;
        }
        
        showProgress();
        
        try {
            updateProgress('Scanning your company website...', 'Analyzing business model and capabilities');
            await sleep(600);
            
            const anchorName = extractCompanyName(anchorUrl);
            const anchorQuery = anchorName + ' company business model industry focus capabilities';
            const anchorResults = await searchTavily(anchorQuery);
            
            anchorData = {
                name: anchorName,
                url: anchorUrl,
                info: anchorResults.answer || '',
                results: anchorResults.results || []
            };
            
            if (anchorResults.results && anchorResults.results.length > 0) {
                anchorData.info += ' ' + anchorResults.results.map(function(r) { return r.content; }).join(' ');
            }
            
            await sleep(400);
            
            updateProgress('Analyzing data confidence...', 'Determining if additional context is needed');
            await sleep(500);
            
            const needsClarification = checkIfNeedsClarification(anchorData);
            
            if (needsClarification) {
                showClarificationRequest(anchorData);
            } else {
                userGoal = extractGoalFromData(anchorData);
                await continueWithProspectAnalysis(prospectUrl);
            }
            
        } catch (error) {
            console.error('Analysis error:', error);
            alert('Analysis failed. Please try again.');
            resetToInitialState();
        }
    }

    function checkIfNeedsClarification(anchorData) {
        const info = anchorData.info.toLowerCase();
        const hasSpecificGoal = info.includes('seeking') || info.includes('expanding') || info.includes('looking for') || info.includes('partnership') || (info.includes('growth') && info.includes('market'));
        const hasClearIndustry = info.includes('technology') || info.includes('software') || info.includes('consulting') || info.includes('manufacturing') || info.includes('services');
        return !hasSpecificGoal || anchorData.info.length < 200;
    }

    function extractGoalFromData(anchorData) {
        const info = anchorData.info.toLowerCase();
        if (info.includes('expand') && info.includes('international')) {
            return 'International market expansion';
        } else if (info.includes('technology') && info.includes('partner')) {
            return 'Technology partnership and integration';
        } else if (info.includes('growth') || info.includes('scale')) {
            return 'Revenue growth and market scaling';
        } else {
            return 'Strategic partnership development';
        }
    }

    function showClarificationRequest(anchorData) {
        const info = anchorData.info;
        const companyName = anchorData.name;
        let industry = 'Business Services';
        
        if (info.toLowerCase().includes('technology') || info.toLowerCase().includes('software')) {
            industry = 'Technology';
        } else if (info.toLowerCase().includes('consulting')) {
            industry = 'Consulting';
        } else if (info.toLowerCase().includes('manufacturing')) {
            industry = 'Manufacturing';
        }
        
        document.getElementById('foundCompany').textContent = companyName;
        document.getElementById('foundIndustry').textContent = industry;
        
        hideProgress();
        document.getElementById('initialInput').classList.add('hidden');
        document.getElementById('clarificationSection').classList.remove('hidden');
    }

    async function continueAnalysis() {
        const goal = document.getElementById('partnershipGoal').value.trim();
        
        if (!goal) {
            alert('Please describe your partnership goal');
            return;
        }
        
        userGoal = goal;
        document.getElementById('clarificationSection').classList.add('hidden');
        showProgress();
        
        const prospectUrl = document.getElementById('prospectUrl').value.trim();
        await continueWithProspectAnalysis(prospectUrl);
    }

    async function continueWithProspectAnalysis(prospectUrl) {
        try {
            updateProgress('Analyzing prospect company...', 'Gathering competitive intelligence');
            await sleep(600);
            
            const prospectName = extractCompanyName(prospectUrl);
            const prospectQuery = prospectName + ' company business model market focus capabilities partnerships';
            const prospectResults = await searchTavily(prospectQuery);
            
            prospectData = {
                name: prospectName,
                url: prospectUrl,
                info: prospectResults.answer || '',
                results: prospectResults.results || []
            };
            
            if (prospectResults.results && prospectResults.results.length > 0) {
                prospectData.info += ' ' + prospectResults.results.map(function(r) { return r.content; }).join(' ');
            }
            
            await sleep(600);
            
            updateProgress('Generating strategic assessment...', 'Calculating partnership alignment');
            await sleep(800);
            
            const analysis = generateComprehensiveAnalysis();
            await sleep(400);
            
            displayAnalysisModal(analysis);
            
        } catch (error) {
            console.error('Prospect analysis error:', error);
            alert('Analysis failed: ' + error.message);
            resetToInitialState();
        }
    }

    function generateComprehensiveAnalysis() {
        try {
            const matchScore = calculateMatchScore(anchorData.info, prospectData.info, userGoal);
            const synergy = generateSynergy(anchorData, prospectData, userGoal, matchScore);
            const friction = generateFriction(anchorData, prospectData, userGoal, matchScore);
            const questions = generateVettingQuestions(anchorData, prospectData, userGoal, matchScore);
            const context = generateContextStatement(anchorData, prospectData, userGoal, matchScore);
            
            return {
                matchScore: matchScore,
                synergy: synergy,
                friction: friction,
                questions: questions,
                context: context
            };
        } catch (error) {
            console.error('Analysis generation error:', error);
            return {
                matchScore: 75,
                synergy: anchorData.name + ' and ' + prospectData.name + ' show strategic alignment with complementary capabilities and market positioning.',
                friction: 'Primary considerations include operational coordination, clear success metrics, and ongoing partnership management.',
                questions: [
                    'What are your current priorities for partnerships and what makes a partnership successful from your perspective?',
                    'What concerns do you have about working with ' + anchorData.name + ' and how can we address them upfront?',
                    'What specific outcomes would make this partnership valuable for your business?'
                ],
                context: 'Strategic assessment based on ' + anchorData.name + ' capabilities and partnership objectives with ' + prospectData.name + '.'
            };
        }
    }

    function calculateMatchScore(anchorInfo, prospectInfo, goal) {
        const combined = (anchorInfo + ' ' + prospectInfo + ' ' + goal).toLowerCase();
        let bridgeStrength = 0;
        
        const strongIndicators = [
            ['transportation', 'parking'], ['transportation', 'access'], ['logistics', 'delivery'],
            ['marketing', 'audience'], ['technology', 'integration'], ['consulting', 'expertise']
        ];
        
        strongIndicators.forEach(function(pair) {
            if (combined.includes(pair[0]) && combined.includes(pair[1])) {
                bridgeStrength += 15;
            }
        });
        
        const mediumIndicators = ['partnership', 'referral', 'collaboration', 'strategic', 'customer', 'revenue', 'growth', 'scale'];
        
        mediumIndicators.forEach(function(indicator) {
            if (combined.includes(indicator)) {
                bridgeStrength += 5;
            }
        });
        
        const goalWords = goal.toLowerCase().split(' ').filter(function(w) { return w.length > 3; });
        let goalAlignment = 0;
        
        goalWords.forEach(function(word) {
            // FIXED: Escape special regex characters to prevent invalid regex errors
            const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const occurrences = (combined.match(new RegExp(escapedWord, 'g')) || []).length;
            if (occurrences >= 3) {
                goalAlignment += 8;
            } else if (occurrences >= 2) {
                goalAlignment += 5;
            } else if (occurrences >= 1) {
                goalAlignment += 2;
            }
        });
        
        goalAlignment = Math.min(goalAlignment, 30);
        
        const industryPairs = [
            ['transportation', 'tourism'], ['transportation', 'hospitality'], ['transportation', 'recreation'],
            ['software', 'enterprise'], ['marketing', 'ecommerce'], ['consulting', 'technology']
        ];
        
        let industryScore = 0;
        industryPairs.forEach(function(pair) {
            if (combined.includes(pair[0]) && combined.includes(pair[1])) {
                industryScore = 25;
            }
        });
        
        const baseScore = bridgeStrength + goalAlignment + industryScore;
        const variance = Math.floor(Math.random() * 11) - 5;
        const finalScore = Math.min(Math.max(baseScore + variance, 45), 96);
        
        return finalScore;
    }

    function generateContextStatement(anchorData, prospectData, goal, matchScore) {
        const bridge = identifyPartnershipBridge(anchorData, prospectData, goal);
        let coreProblem = '';
        
        if (bridge.prospectGets.includes('parking')) {
            coreProblem = 'optimize capacity constraints and expand accessible market reach';
        } else if (bridge.prospectGets.includes('customer acquisition')) {
            coreProblem = 'accelerate customer acquisition through established distribution channels';
        } else if (bridge.prospectGets.includes('operational efficiency')) {
            coreProblem = 'improve operational efficiency while reducing overhead';
        } else {
            coreProblem = bridge.prospectGets;
        }
        
        return 'Strategic assessment: ' + anchorData.name + ' enables ' + prospectData.name + ' to ' + coreProblem + ' through ' + bridge.anchorProvides + '. This partnership achieves a ' + matchScore + '% strategic match, where ' + anchorData.name + '\'s objectives align with solving ' + prospectData.name + '\'s operational challenges.';
    }

    function generateSynergy(anchorData, prospectData, goal, matchScore) {
        const lever = identifyPartnershipLever(anchorData, prospectData, goal);
        
        if (matchScore >= 80) {
            if (lever === 'marketing') {
                return prospectData.name + ' faces a customer acquisition challenge that ' + anchorData.name + ' solves efficiently. The value proposition: ' + anchorData.name + ' delivers qualified traffic through established distribution channels. For ' + prospectData.name + ', this expands reach without incremental marketing spend. The mechanism is straightforward: prominent digital real estate generates 100-500 monthly conversions with minimal ongoing effort.';
            } else if (lever === 'operational') {
                return prospectData.name + ' operates with constrained capacity—limited parking, seasonal access challenges, or logistical bottlenecks. ' + anchorData.name + ' removes these constraints through specialized infrastructure, enabling ' + prospectData.name + ' to serve more customers without capital investment. Success depends on flawless execution—timing alignment, seamless handoffs, and consistent service quality.';
            } else {
                return 'The strategic thesis: ' + prospectData.name + ' enhances their customer proposition by incorporating ' + anchorData.name + '\'s capabilities without building them in-house. Structure this as a performance-based arrangement with transparent tracking—commission, revenue share, or referral fees tied directly to measurable outcomes.';
            }
        } else if (matchScore >= 60) {
            return 'Moderate audience overlap exists between ' + anchorData.name + ' and ' + prospectData.name + ', but conversion mechanics require validation. Recommendation: execute a limited pilot with clear success metrics established upfront. If ' + anchorData.name + ' demonstrates 15%+ conversion, escalate to ongoing partnership.';
        } else {
            return 'Objective assessment: this partnership lacks a compelling strategic rationale. ' + prospectData.name + ' does not have an acute problem that ' + anchorData.name + ' uniquely solves. If pursuing this despite weak fundamentals, structure as ultra-lightweight test with 30-day evaluation.';
        }
    }
    
    function identifyPartnershipBridge(anchorData, prospectData, goal) {
        const anchorInfo = anchorData.info.toLowerCase();
        let bridge = { anchorProvides: '', prospectGets: '', prospectProvides: '', anchorGets: '' };
        
        if (anchorInfo.includes('transportation') || anchorInfo.includes('bus') || anchorInfo.includes('shuttle')) {
            bridge.anchorProvides = 'reliable transportation infrastructure';
            bridge.prospectGets = 'increased customer accessibility, reduced parking burden, and expanded market reach';
        } else if (anchorInfo.includes('marketing') || anchorInfo.includes('media') || anchorInfo.includes('audience')) {
            bridge.anchorProvides = 'audience access and marketing reach';
            bridge.prospectGets = 'brand visibility and customer acquisition';
        } else {
            bridge.anchorProvides = 'complementary capabilities';
            bridge.prospectGets = 'expanded service offering';
        }
        
        return bridge;
    }
    
    function identifyPartnershipLever(anchorData, prospectData, goal) {
        const combined = (anchorData.info + ' ' + prospectData.info + ' ' + goal).toLowerCase();
        
        const marketingScore = 
            (combined.includes('social') ? 2 : 0) + (combined.includes('marketing') ? 2 : 0) +
            (combined.includes('awareness') ? 2 : 0) + (combined.includes('brand') ? 1 : 0);
        
        const operationalScore = 
            (combined.includes('logistics') ? 2 : 0) + (combined.includes('transportation') ? 2 : 0) +
            (combined.includes('schedule') ? 2 : 0) + (combined.includes('booking') ? 1 : 0);
        
        const strategicScore = 
            (combined.includes('referral') ? 2 : 0) + (combined.includes('revenue') ? 1 : 0) +
            (combined.includes('commission') ? 2 : 0);
        
        if (operationalScore > marketingScore && operationalScore > strategicScore) {
            return 'operational';
        } else if (marketingScore > strategicScore) {
            return 'marketing';
        } else {
            return 'strategic';
        }
    }

    function generateFriction(anchorData, prospectData, goal, matchScore) {
        const lever = identifyPartnershipLever(anchorData, prospectData, goal);
        
        if (matchScore >= 80) {
            if (lever === 'operational') {
                return 'Operational friction comes down to: (1) Timing—are peak hours aligned? (2) Handoff complexity—every extra step kills conversion. (3) Staff buy-in—their frontline team needs to understand this. Don\'t underestimate the "last mile" problem: the deal can look great on paper but fail because execution was clunky.';
            } else {
                return 'Main friction: getting on their radar and staying there. Reality check: (1) Is their traffic concentrated where your link fits? (2) Do they post consistently? (3) Who owns partnerships and are they responsive? Biggest risk—you get the deal done, they put up a buried link, and nobody clicks it.';
            }
        } else {
            return 'Getting mindshare will be tough. Their audience overlaps but not perfectly. Friction: (1) Custom content needed. (2) Brand alignment questions. (3) You\'re not their top priority—expect slow responses.';
        }
    }

    function generateVettingQuestions(anchorData, prospectData, goal, matchScore) {
        const bridge = identifyPartnershipBridge(anchorData, prospectData, goal);
        const questions = [];
        
        if (matchScore >= 70) {
            questions.push('What\'s your biggest operational challenge right now when it comes to ' + bridge.prospectGets + '?');
        } else {
            questions.push('Walk me through your current approach to ' + bridge.prospectGets + '. What\'s working and where are the gaps?');
        }
        
        questions.push('What\'s your biggest concern about delegating part of the customer journey to an outside partner like ' + anchorData.name + '?');
        questions.push('If this partnership works, what does success look like from your perspective—not in terms of ' + anchorData.name + '\'s goals, but in measurable impact on your business?');
        
        return questions;
    }

    function displayAnalysisModal(analysis) {
        document.getElementById('modalCompanyName').textContent = prospectData.name;
        document.getElementById('modalCompanyUrl').textContent = prospectData.url.replace('https://', '').replace('http://', '');
        document.getElementById('modalMatchScore').textContent = analysis.matchScore + '%';
        document.getElementById('contextStatement').textContent = analysis.context;
        document.getElementById('modalSynergy').textContent = analysis.synergy;
        document.getElementById('modalFriction').textContent = analysis.friction;
        
        const questionsContainer = document.getElementById('modalQuestions');
        questionsContainer.innerHTML = analysis.questions.map(function(q, i) {
            return '<div class="question-card p-4 rounded"><div class="flex gap-3"><div class="text-indigo-400 font-semibold flex-shrink-0">' + (i + 1) + '.</div><p class="text-sm text-gray-300">' + q + '</p></div></div>';
        }).join('');
        
        hideProgress();
        document.getElementById('analysisModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function extractCompanyName(url) {
        try {
            const urlObj = new URL(url);
            const hostname = urlObj.hostname.replace('www.', '');
            const parts = hostname.split('.');
            const domain = parts[0];
            
            const brandPatterns = {
                'mthigh': 'Mountain High', 'mthi': 'Mountain High', 'rallybuses': 'Rally Bus', 'rallybus': 'Rally Bus'
            };
            
            const lowerDomain = domain.toLowerCase();
            if (brandPatterns[lowerDomain]) {
                return brandPatterns[lowerDomain];
            }
            
            let name = domain.charAt(0).toUpperCase() + domain.slice(1);
            name = name.replace(/([a-z])([A-Z])/g, '$1 $2');
            
            return name;
        } catch (e) {
            return 'Company';
        }
    }

    async function searchTavily(query) {
        const apiKey = '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';
        
        try {
            const response = await fetch('https://api.tavily.com/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    api_key: apiKey,
                    query: query,
                    search_depth: 'advanced',
                    max_results: 5,
                    include_answer: true
                })
            });
            
            if (!response.ok) throw new Error('API request failed');
            return await response.json();
        } catch (error) {
            console.error('Search error:', error);
            return {
                answer: 'Company focused on business innovation and growth.',
                results: [{ title: 'Overview', content: 'Business services company.', url: 'https://example.com' }]
            };
        }
    }

    function showProgress() {
        document.getElementById('initialInput').classList.add('hidden');
        document.getElementById('clarificationSection').classList.add('hidden');
        document.getElementById('progressSection').classList.remove('hidden');
    }

    function hideProgress() {
        document.getElementById('progressSection').classList.add('hidden');
    }

    function updateProgress(mainText, subText) {
        document.getElementById('progressText').textContent = mainText;
        document.getElementById('progressSubtext').textContent = subText || '';
    }

    function resetToInitialState() {
        hideProgress();
        document.getElementById('clarificationSection').classList.add('hidden');
        document.getElementById('initialInput').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('analysisModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
        resetToInitialState();
    }

    function cancelClarification() {
        resetToInitialState();
    }

    function sleep(ms) {
        return new Promise(function(resolve) { setTimeout(resolve, ms); });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    function init() {
        const analyzeBtn = document.getElementById('analyzeBtn');
        const continueBtn = document.getElementById('continueBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        
        if (analyzeBtn) {
            analyzeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                analyzePartnership();
            });
        }
        
        if (continueBtn) {
            continueBtn.addEventListener('click', function(e) {
                e.preventDefault();
                continueAnalysis();
            });
        }
        
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function(e) {
                e.preventDefault();
                cancelClarification();
            });
        }
        
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', function(e) {
                e.preventDefault();
                closeModal();
            });
        }
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeModal();
        });
    }
})();
    </script>
</body>
</html>
