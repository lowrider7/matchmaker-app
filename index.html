<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Partner Scout | Intelligence Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: #0a0f1e;
            min-height: 100vh;
        }
        
        .analyzer-card {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(71, 85, 105, 0.3);
        }
        
        .scan-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(71, 85, 105, 0.5);
            transition: all 0.3s ease;
        }
        
        .scan-input:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.6);
            background: rgba(0, 0, 0, 0.6);
        }
        
        .clarification-box {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            animation: slideDown 0.4s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
            border: 2px solid rgba(99, 102, 241, 0.3);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.4s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .progress-bar {
            width: 100%;
            height: 2px;
            background: rgba(71, 85, 105, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            animation: progress 2.5s ease-in-out;
        }
        
        @keyframes progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .match-score {
            font-size: 4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(71, 85, 105, 0.5), transparent);
        }
        
        .question-card {
            background: rgba(99, 102, 241, 0.05);
            border-left: 2px solid rgba(99, 102, 241, 0.5);
            transition: all 0.2s ease;
        }
        
        .question-card:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .friction-card {
            background: rgba(239, 68, 68, 0.05);
            border-left: 2px solid rgba(239, 68, 68, 0.5);
        }
        
        .hidden {
            display: none !important;
        }
        
        .insight-badge {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #86efac;
        }
    </style>
</head>
<body class="text-gray-100">
    <div class="min-h-screen p-6">
        <div class="max-w-4xl mx-auto">
            <!-- Minimal Header -->
            <div class="mb-8 text-center">
                <h1 class="text-3xl font-light text-gray-300 mb-1">Strategic Partner Scout</h1>
                <p class="text-sm text-gray-500">AI-Powered Partnership Intelligence</p>
            </div>

            <!-- Main Analyzer -->
            <div class="analyzer-card rounded-lg p-8">
                <h2 class="text-xl font-medium mb-6">Partnership Analysis</h2>
                
                <!-- Initial URL Input -->
                <div id="initialInput">
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="text-sm text-gray-400 mb-2 block">Your Company Website</label>
                            <input 
                                type="url" 
                                id="anchorUrl"
                                placeholder="https://your-company.com"
                                class="scan-input w-full px-4 py-3 rounded text-sm"
                            />
                        </div>
                        
                        <div>
                            <label class="text-sm text-gray-400 mb-2 block">Prospect Company Website</label>
                            <input 
                                type="url" 
                                id="prospectUrl"
                                placeholder="https://prospect-company.com"
                                class="scan-input w-full px-4 py-3 rounded text-sm"
                            />
                        </div>
                    </div>
                    
                    <button 
                        id="analyzeBtn"
                        type="button"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 px-6 py-3 rounded font-medium transition-all"
                    >
                        Analyze Partnership Fit
                    </button>
                </div>
                
                <!-- Progress Indicator -->
                <div id="progressSection" class="hidden">
                    <div class="text-center py-12">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-sm text-gray-400 mb-2" id="progressText">Initializing scan...</p>
                        <p class="text-xs text-gray-500" id="progressSubtext"></p>
                        <div class="progress-bar mt-4">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Clarification Request -->
                <div id="clarificationSection" class="hidden">
                    <div class="clarification-box rounded-lg p-6 mb-4">
                        <div class="flex items-start gap-3 mb-4">
                            <div class="insight-badge px-3 py-1 rounded-full text-xs font-semibold">
                                AI Insight
                            </div>
                        </div>
                        
                        <h3 class="text-lg font-semibold mb-2">Almost there!</h3>
                        <p class="text-sm text-gray-400 mb-4" id="clarificationMessage">
                            We scanned your website but need one more detail to provide accurate partnership analysis.
                        </p>
                        
                        <div class="mb-4">
                            <label class="text-sm text-gray-400 mb-2 block">What is your primary partnership goal?</label>
                            <input 
                                type="text" 
                                id="partnershipGoal"
                                placeholder="e.g., Scaling in Mexico, Revenue Growth, Technical Integration"
                                class="scan-input w-full px-4 py-3 rounded text-sm"
                            />
                            <p class="text-xs text-gray-500 mt-2">Be specific: mention geographic markets, revenue targets, or technical capabilities you're seeking.</p>
                        </div>
                        
                        <div class="flex gap-3">
                            <button 
                                id="continueBtn"
                                type="button"
                                class="flex-1 bg-indigo-600 hover:bg-indigo-700 px-6 py-3 rounded font-medium transition-all"
                            >
                                Continue Analysis
                            </button>
                            <button 
                                id="cancelBtn"
                                type="button"
                                class="px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded font-medium transition-all"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Show what we found -->
                    <div class="text-xs text-gray-500 space-y-1">
                        <p>✓ Company identified: <span id="foundCompany" class="text-gray-400"></span></p>
                        <p>✓ Industry detected: <span id="foundIndustry" class="text-gray-400"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div id="analysisModal" class="modal-overlay hidden">
        <div class="modal-content rounded-lg">
            <div class="p-8">
                <!-- Header -->
                <div class="flex items-start justify-between mb-8">
                    <div>
                        <h3 class="text-2xl font-semibold mb-1" id="modalCompanyName">Company Name</h3>
                        <p class="text-sm text-gray-400" id="modalCompanyUrl">company.com</p>
                    </div>
                    <button id="closeModalBtn" type="button" class="p-2 hover:bg-slate-700/50 rounded transition-all">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Match Score -->
                <div class="text-center mb-8">
                    <div class="match-score mb-2" id="modalMatchScore">0%</div>
                    <p class="text-xs text-gray-500 uppercase tracking-wider">Revenue Potential Score</p>
                </div>
                
                <div class="section-divider mb-8"></div>
                
                <!-- Context Statement -->
                <div class="mb-8">
                    <div class="bg-indigo-900/20 border border-indigo-500/30 rounded-lg p-4">
                        <p class="text-sm text-gray-300" id="contextStatement">
                            Strategic assessment...
                        </p>
                    </div>
                </div>
                
                <!-- Strategic Synergy -->
                <div class="mb-8">
                    <h4 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-3">What Rally Gets</h4>
                    <p class="text-gray-300 leading-relaxed" id="modalSynergy">Analysis results...</p>
                </div>
                
                <!-- Potential Friction -->
                <div class="mb-8">
                    <h4 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-3">Execution Risk</h4>
                    <div class="friction-card p-4 rounded">
                        <p class="text-gray-300 text-sm leading-relaxed" id="modalFriction">Friction analysis...</p>
                    </div>
                </div>
                
                <div class="section-divider mb-8"></div>
                
                <!-- Vetting Questions -->
                <div>
                    <h4 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">Due Diligence</h4>
                    <div class="space-y-3" id="modalQuestions">
                        <!-- Questions will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
(function() {
    'use strict';
    
    const supabaseUrl = 'https://xotwovmpqxqjexpuulxc.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhvdHdvdm1wcXhxamV4cHV1bHhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NDYwMjksImV4cCI6MjA4MzIyMjAyOX0.Hr-hwo1nlFx55HZuLI8cqoT6snHAR6hp_q8mOXfn1-I';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let anchorData = {};
    let prospectData = {};
    let userGoal = '';

    async function analyzePartnership() {
        const anchorUrl = document.getElementById('anchorUrl').value.trim();
        const prospectUrl = document.getElementById('prospectUrl').value.trim();
        
        if (!anchorUrl || !prospectUrl) {
            alert('Please enter both company websites');
            return;
        }
        
        try {
            new URL(anchorUrl);
            new URL(prospectUrl);
        } catch (e) {
            alert('Please enter valid URLs');
            return;
        }
        
        showProgress();
        
        try {
            updateProgress('Scanning your company website...', 'Analyzing business model and capabilities');
            await sleep(600);
            
            const anchorName = extractCompanyName(anchorUrl);
            const anchorQuery = anchorName + ' company business model industry focus capabilities';
            const anchorResults = await searchTavily(anchorQuery);
            
            anchorData = {
                name: anchorName,
                url: anchorUrl,
                info: anchorResults.answer || '',
                results: anchorResults.results || []
            };
            
            if (anchorResults.results && anchorResults.results.length > 0) {
                anchorData.info += ' ' + anchorResults.results.map(function(r) { return r.content; }).join(' ');
            }
            
            await sleep(400);
            
            updateProgress('Analyzing data confidence...', 'Determining if additional context is needed');
            await sleep(500);
            
            const needsClarification = checkIfNeedsClarification(anchorData);
            
            if (needsClarification) {
                showClarificationRequest(anchorData);
            } else {
                userGoal = extractGoalFromData(anchorData);
                await continueWithProspectAnalysis(prospectUrl);
            }
            
        } catch (error) {
            console.error('Analysis error:', error);
            alert('Analysis failed. Please try again.');
            resetToInitialState();
        }
    }

    function checkIfNeedsClarification(anchorData) {
        const info = anchorData.info.toLowerCase();
        const hasSpecificGoal = info.includes('seeking') || info.includes('expanding') || info.includes('looking for') || info.includes('partnership') || (info.includes('growth') && info.includes('market'));
        const hasClearIndustry = info.includes('technology') || info.includes('software') || info.includes('consulting') || info.includes('manufacturing') || info.includes('services');
        return !hasSpecificGoal || anchorData.info.length < 200;
    }

    function extractGoalFromData(anchorData) {
        const info = anchorData.info.toLowerCase();
        if (info.includes('expand') && info.includes('international')) {
            return 'expanding into international markets';
        } else if (info.includes('technology') && info.includes('partner')) {
            return 'building technology partnerships';
        } else if (info.includes('growth') || info.includes('scale')) {
            return 'scaling revenue and market presence';
        } else {
            return 'developing strategic partnerships';
        }
    }

    function showClarificationRequest(anchorData) {
        const info = anchorData.info;
        const companyName = anchorData.name;
        let industry = 'Business Services';
        
        if (info.toLowerCase().includes('technology') || info.toLowerCase().includes('software')) {
            industry = 'Technology';
        } else if (info.toLowerCase().includes('consulting')) {
            industry = 'Consulting';
        } else if (info.toLowerCase().includes('manufacturing')) {
            industry = 'Manufacturing';
        }
        
        document.getElementById('foundCompany').textContent = companyName;
        document.getElementById('foundIndustry').textContent = industry;
        
        hideProgress();
        document.getElementById('initialInput').classList.add('hidden');
        document.getElementById('clarificationSection').classList.remove('hidden');
    }

    async function continueAnalysis() {
        const goal = document.getElementById('partnershipGoal').value.trim();
        
        if (!goal) {
            alert('Please describe your partnership goal');
            return;
        }
        
        userGoal = goal;
        document.getElementById('clarificationSection').classList.add('hidden');
        showProgress();
        
        const prospectUrl = document.getElementById('prospectUrl').value.trim();
        await continueWithProspectAnalysis(prospectUrl);
    }

    async function continueWithProspectAnalysis(prospectUrl) {
        try {
            updateProgress('Analyzing prospect company...', 'Gathering competitive intelligence');
            await sleep(600);
            
            const prospectName = extractCompanyName(prospectUrl);
            const prospectQuery = prospectName + ' company business model market focus capabilities partnerships';
            const prospectResults = await searchTavily(prospectQuery);
            
            prospectData = {
                name: prospectName,
                url: prospectUrl,
                info: prospectResults.answer || '',
                results: prospectResults.results || []
            };
            
            if (prospectResults.results && prospectResults.results.length > 0) {
                prospectData.info += ' ' + prospectResults.results.map(function(r) { return r.content; }).join(' ');
            }
            
            await sleep(600);
            
            updateProgress('Generating strategic assessment...', 'Calculating revenue potential');
            await sleep(800);
            
            const analysis = generateComprehensiveAnalysis();
            await sleep(400);
            
            displayAnalysisModal(analysis);
            
        } catch (error) {
            console.error('Prospect analysis error:', error);
            alert('Analysis failed: ' + error.message);
            resetToInitialState();
        }
    }

    function generateComprehensiveAnalysis() {
        try {
            const revenueImpact = calculateRevenueImpact(anchorData.info, prospectData.info, userGoal);
            const synergy = generateRallyWin(anchorData, prospectData, userGoal, revenueImpact);
            const friction = generateExecutionRisk(anchorData, prospectData, userGoal, revenueImpact);
            const questions = generateDueDiligence(anchorData, prospectData, userGoal, revenueImpact);
            const context = generateExecutiveSummary(anchorData, prospectData, userGoal, revenueImpact);
            
            return {
                matchScore: revenueImpact.score,
                synergy: synergy,
                friction: friction,
                questions: questions,
                context: context
            };
        } catch (error) {
            console.error('Analysis generation error:', error);
            return {
                matchScore: 75,
                synergy: anchorData.name + ' gains access to ' + prospectData.name + '\'s customer base and distribution channels.',
                friction: 'Primary execution risks include partnership activation timeline and ongoing coordination requirements.',
                questions: [
                    'What volume can they realistically commit to in the first 90 days?',
                    'Who internally has authority to execute this partnership?',
                    'What are the deal-breakers on their end that would kill this?'
                ],
                context: 'Partnership assessment for ' + anchorData.name + ' and ' + prospectData.name + ' based on revenue potential analysis.'
            };
        }
    }

    function calculateRevenueImpact(anchorInfo, prospectInfo, goal) {
        const combined = (anchorInfo + ' ' + prospectInfo + ' ' + goal).toLowerCase();
        
        // High-value indicators: steady demand sources worth 20 points each
        let demandScore = 0;
        const demandIndicators = ['hotel', 'resort', 'venue', 'destination', 'tourism', 'hospitality', 'events'];
        demandIndicators.forEach(function(indicator) {
            if (combined.includes(indicator)) demandScore += 20;
        });
        demandScore = Math.min(demandScore, 40);
        
        // Volume indicators: scale matters, worth 15 points each
        let volumeScore = 0;
        const volumeIndicators = ['thousand', 'million', 'large', 'major', 'leading', 'nationwide'];
        volumeIndicators.forEach(function(indicator) {
            if (combined.includes(indicator)) volumeScore += 15;
        });
        volumeScore = Math.min(volumeScore, 30);
        
        // Operational fit: easy execution worth 10 points each
        let operationalScore = 0;
        const operationalIndicators = ['parking', 'shuttle', 'transportation', 'access', 'location'];
        operationalIndicators.forEach(function(indicator) {
            if (combined.includes(indicator)) operationalScore += 10;
        });
        operationalScore = Math.min(operationalScore, 20);
        
        // Calculate total with small variance
        const baseScore = demandScore + volumeScore + operationalScore;
        const variance = Math.floor(Math.random() * 11) - 5;
        const finalScore = Math.min(Math.max(baseScore + variance, 50), 96);
        
        // Determine volume tier based on score
        let volumeTier = 'low';
        let monthlyVolume = '50-100';
        if (finalScore >= 85) {
            volumeTier = 'high';
            monthlyVolume = '400-800';
        } else if (finalScore >= 70) {
            volumeTier = 'medium';
            monthlyVolume = '150-300';
        }
        
        return {
            score: finalScore,
            volumeTier: volumeTier,
            monthlyVolume: monthlyVolume,
            hasSteadyDemand: demandScore > 0,
            hasScale: volumeScore > 0,
            easyExecution: operationalScore >= 10
        };
    }

    function generateExecutiveSummary(anchorData, prospectData, goal, revenueImpact) {
        const mechanismType = determineMechanismType(anchorData, prospectData);
        return prospectData.name + ' represents a ' + revenueImpact.score + '% revenue opportunity for ' + anchorData.name + '. Projected monthly volume: ' + revenueImpact.monthlyVolume + ' seats. Execution mechanism: ' + mechanismType + '. This assessment factors in demand consistency, volume potential, and operational lift required.';
    }

    function generateRallyWin(anchorData, prospectData, goal, revenueImpact) {
        const mechanismType = determineMechanismType(anchorData, prospectData);
        
        if (revenueImpact.score >= 85) {
            if (revenueImpact.hasSteadyDemand) {
                return prospectData.name + ' delivers high-frequency, predictable demand that maximizes ' + anchorData.name + '\'s seat yield. This is a tier-one partnership: ' + revenueImpact.monthlyVolume + ' monthly seats driven by their captive customer base. Execution is ' + mechanismType + '—they handle customer communication, ' + anchorData.name + ' handles fulfillment. Revenue model is straightforward: either they buy blocks of seats at wholesale or ' + anchorData.name + ' pays them per confirmed booking. The value here isn\'t marketing exposure—it\'s guaranteed inventory absorption during peak and off-peak periods. Their customers have no car, need to get somewhere ' + anchorData.name + ' serves, and ' + prospectData.name + ' becomes the default solution.';
            } else {
                return prospectData.name + ' provides ' + anchorData.name + ' with high-volume distribution access. Estimated ' + revenueImpact.monthlyVolume + ' monthly seats through their existing channels. Implementation: ' + mechanismType + '. The economics work because their customer acquisition cost is zero for ' + anchorData.name + '—they\'ve already paid to acquire and serve these customers. ' + anchorData.name + ' slots into their existing operations as an added-value service. Commission or revenue-share structure keeps incentives aligned. This scales ' + anchorData.name + '\'s regional footprint without incremental marketing spend.';
            }
        } else if (revenueImpact.score >= 70) {
            return prospectData.name + ' offers ' + anchorData.name + ' moderate volume opportunity: ' + revenueImpact.monthlyVolume + ' monthly seats based on their customer flow. This isn\'t transformational but it\'s solid supplemental demand. Execution: ' + mechanismType + '. The partnership makes sense if ' + prospectData.name + ' actively promotes it—not just passive link placement. ' + anchorData.name + ' needs them pushing this through their booking flow, email communications, and on-site touchpoints. Revenue impact depends entirely on how much mindshare ' + prospectData.name + ' allocates to this partnership versus their other priorities.';
        } else {
            return prospectData.name + ' represents exploratory volume for ' + anchorData.name + ': ' + revenueImpact.monthlyVolume + ' estimated monthly seats. This is a test-and-learn opportunity rather than a core partnership. Execution: ' + mechanismType + '. The lift-to-value ratio is marginal—' + anchorData.name + ' will invest time setting this up for uncertain demand. Recommend 60-day pilot with clear success metrics: if they don\'t drive 100+ confirmed bookings in 60 days, the partnership doesn\'t justify ongoing attention. Focus ' + anchorData.name + '\'s BD resources on higher-probability prospects.';
        }
    }

    function determineMechanismType(anchorData, prospectData) {
        const combined = (anchorData.info + ' ' + prospectData.info).toLowerCase();
        
        if (combined.includes('website') || combined.includes('online') || combined.includes('digital')) {
            return 'digital link placement on their high-traffic pages';
        } else if (combined.includes('booking') || combined.includes('reservation')) {
            return 'integrated booking flow';
        } else if (combined.includes('concierge') || combined.includes('front desk')) {
            return 'direct referrals from their staff';
        } else if (combined.includes('email') || combined.includes('newsletter')) {
            return 'email promotions to their customer list';
        } else {
            return 'strategic customer delivery';
        }
    }

    function generateExecutionRisk(anchorData, prospectData, goal, revenueImpact) {
        if (revenueImpact.score >= 85) {
            if (revenueImpact.easyExecution) {
                return 'Low execution risk. This is straightforward: link placement or booking integration, no complex operations. Primary risk is getting their internal team to prioritize launch. Secondary risk: their customers don\'t convert because ' + anchorData.name + '\'s schedule doesn\'t align with their peak demand times. Mitigation: lock in launch timeline before spending BD cycles on this, and validate schedule fit during diligence.';
            } else {
                return 'Moderate execution risk despite high revenue potential. The volume is there but execution requires coordination: schedule alignment, potentially white-label booking, and ongoing communication. Risk: this launches, drives initial volume, then degrades because nobody at ' + prospectData.name + ' owns it long-term. Mitigation: establish executive sponsor on their side and quarterly business reviews tied to volume commitments.';
            }
        } else if (revenueImpact.score >= 70) {
            return 'Moderate risk, moderate reward. The partnership economics are unclear—will they actively promote ' + anchorData.name + ' or just passively enable it? Without active promotion, this generates minimal volume. Risk: ' + anchorData.name + ' invests setup effort for partnership that never gains traction. Mitigation: require promotional commitment in writing—X emails per quarter, Y social posts, Z website placements. If they won\'t commit to promotion, don\'t do the deal.';
        } else {
            return 'High execution risk relative to potential return. The volume projections are optimistic and assume ' + prospectData.name + ' becomes an active sales channel for ' + anchorData.name + ', which rarely happens organically. Risk: six months from now, this partnership exists on paper but drives 10 bookings per month. Realistic assessment: unless ' + prospectData.name + ' has burning customer demand for ' + anchorData.name + '\'s service, this won\'t scale. Walk away unless they can demonstrate existing customer requests for what ' + anchorData.name + ' provides.';
        }
    }

    function generateDueDiligence(anchorData, prospectData, goal, revenueImpact) {
        const questions = [];
        
        questions.push('What\'s your current monthly customer volume at the location(s) relevant to ' + anchorData.name + '\'s routes, and what percentage realistically need transportation to those destinations?');
        
        if (revenueImpact.score >= 80) {
            questions.push('Walk me through exactly how you\'d present ' + anchorData.name + ' to your customers—website placement, booking integration, staff training. Show me mockups or describe the customer journey in detail.');
        } else {
            questions.push('Why would your customers choose ' + anchorData.name + ' over driving themselves, and how do you currently solve their transportation needs if you solve them at all?');
        }
        
        questions.push('What commission or revenue-share structure makes this worth your team\'s time, and who internally owns partnership revenue—is this someone\'s bonus line item or just a "nice to have"?');
        
        return questions;
    }

    function displayAnalysisModal(analysis) {
        document.getElementById('modalCompanyName').textContent = prospectData.name;
        document.getElementById('modalCompanyUrl').textContent = prospectData.url.replace('https://', '').replace('http://', '');
        document.getElementById('modalMatchScore').textContent = analysis.matchScore + '%';
        document.getElementById('contextStatement').textContent = analysis.context;
        document.getElementById('modalSynergy').textContent = analysis.synergy;
        document.getElementById('modalFriction').textContent = analysis.friction;
        
        const questionsContainer = document.getElementById('modalQuestions');
        questionsContainer.innerHTML = analysis.questions.map(function(q, i) {
            return '<div class="question-card p-4 rounded"><div class="flex gap-3"><div class="text-indigo-400 font-semibold flex-shrink-0">' + (i + 1) + '.</div><p class="text-sm text-gray-300">' + q + '</p></div></div>';
        }).join('');
        
        hideProgress();
        document.getElementById('analysisModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function extractCompanyName(url) {
        try {
            const urlObj = new URL(url);
            let hostname = urlObj.hostname.replace('www.', '');
            const parts = hostname.split('.');
            const domain = parts[0];
            
            // Expanded brand patterns - proper capitalization and spacing
            const brandPatterns = {
                'mthigh': 'Mountain High Resort',
                'mthi': 'Mountain High',
                'mountainhigh': 'Mountain High Resort',
                'rallybuses': 'Rally',
                'rallybus': 'Rally',
                'rally': 'Rally',
                'starlinecollection': 'Starline Collection',
                'starline': 'Starline Collection',
                'marriott': 'Marriott',
                'hilton': 'Hilton',
                'hyatt': 'Hyatt',
                'ihg': 'IHG Hotels & Resorts',
                'airbnb': 'Airbnb',
                'expedia': 'Expedia',
                'booking': 'Booking.com',
                'hotels': 'Hotels.com'
            };
            
            const lowerDomain = domain.toLowerCase().replace(/[-_]/g, '');
            if (brandPatterns[lowerDomain]) {
                return brandPatterns[lowerDomain];
            }
            
            // Smart capitalization: handle compounds
            let name = domain;
            
            // Check if it's all lowercase or all uppercase
            if (name === name.toLowerCase() || name === name.toUpperCase()) {
                // Add space before capital letters that follow lowercase
                name = name.replace(/([a-z])([A-Z])/g, '$1 $2');
                // Capitalize first letter of each word
                name = name.split(/[\s-_]+/).map(function(word) {
                    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                }).join(' ');
            } else {
                // Already has mixed case, just add spaces
                name = name.replace(/([a-z])([A-Z])/g, '$1 $2');
            }
            
            return name;
        } catch (e) {
            return 'Company';
        }
    }

    async function searchTavily(query) {
        const apiKey = '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';
        
        try {
            const response = await fetch('https://api.tavily.com/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    api_key: apiKey,
                    query: query,
                    search_depth: 'advanced',
                    max_results: 5,
                    include_answer: true
                })
            });
            
            if (!response.ok) throw new Error('API request failed');
            return await response.json();
        } catch (error) {
            console.error('Search error:', error);
            return {
                answer: 'Company focused on business innovation and growth.',
                results: [{ title: 'Overview', content: 'Business services company.', url: 'https://example.com' }]
            };
        }
    }

    function showProgress() {
        document.getElementById('initialInput').classList.add('hidden');
        document.getElementById('clarificationSection').classList.add('hidden');
        document.getElementById('progressSection').classList.remove('hidden');
    }

    function hideProgress() {
        document.getElementById('progressSection').classList.add('hidden');
    }

    function updateProgress(mainText, subText) {
        document.getElementById('progressText').textContent = mainText;
        document.getElementById('progressSubtext').textContent = subText || '';
    }

    function resetToInitialState() {
        hideProgress();
        document.getElementById('clarificationSection').classList.add('hidden');
        document.getElementById('initialInput').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('analysisModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
        resetToInitialState();
    }

    function cancelClarification() {
        resetToInitialState();
    }

    function sleep(ms) {
        return new Promise(function(resolve) { setTimeout(resolve, ms); });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    function init() {
        const analyzeBtn = document.getElementById('analyzeBtn');
        const continueBtn = document.getElementById('continueBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        
        if (analyzeBtn) {
            analyzeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                analyzePartnership();
            });
        }
        
        if (continueBtn) {
            continueBtn.addEventListener('click', function(e) {
                e.preventDefault();
                continueAnalysis();
            });
        }
        
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function(e) {
                e.preventDefault();
                cancelClarification();
            });
        }
        
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', function(e) {
                e.preventDefault();
                closeModal();
            });
        }
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeModal();
        });
    }
})();
    </script>
</body>
</html>
